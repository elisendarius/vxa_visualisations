<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Breed Correlation Heatmap</title>
// ===== Styles ======//
  <link rel="stylesheet" href="../assets/styles.css">
</head>
<body>
<a href="../" class="back-link">← Back to projects</a>
<div class="topbar">
  <div class="titles">
    <h1 id="title">Breed × Trait Correlations</h1>
    <p id="subtitle" class="subtitle">Genomic prediction accuracy across breeds — hover cells for details</p>
  </div>

  <div class="lang" role="group" aria-label="Language toggle">
    <button type="button" id="btn-en" class="active" data-lang="en">EN</button>
    <button type="button" id="btn-sv" data-lang="sv">SV</button>
  </div>
</div>

<div class="tabs">
  <button type="button" class="tab active" data-key="bw" id="tab-bw">Birth Weight</button>
  <button type="button" class="tab" data-key="ww" id="tab-ww">Weaning Weight</button>
  <button type="button" class="tab" data-key="yw" id="tab-yw">Yearling Weight</button>
  <button type="button" class="tab" data-key="adg" id="tab-adg">Daily Gain (ADG)</button>
  <button type="button" class="tab" data-key="all" id="tab-all">All traits</button>
</div>

<div id="tooltip" class="tooltip" aria-hidden="true"></div>

<div id="panel-bw" class="panel active"><div class="card" id="card-bw"></div></div>
<div id="panel-ww" class="panel"><div class="card" id="card-ww"></div></div>
<div id="panel-yw" class="panel"><div class="card" id="card-yw"></div></div>
<div id="panel-adg" class="panel"><div class="card" id="card-adg"></div></div>
<div id="panel-all" class="panel"><div class="card" id="card-all"></div></div>

<!-- Legend -->
<div class="legend" aria-label="Correlation legend">
  <span class="legend-label">−1.0</span>
  <div class="legend-bar" id="legend-bar"></div>
  <span class="legend-label">+1.0</span>
</div>
<p class="source" id="source">n = number of animals per breed</p>

<script>
  // ===== i18n strings =====
  const i18n = {
    en: {
      title: "Breed × Trait Correlations",
      subtitle: "Genomic prediction accuracy across breeds — hover cells for details",
      tabs: { bw:"Birth Weight", ww:"Weaning Weight", yw:"Yearling Weight", adg:"Daily Gain (ADG)", all:"All traits" },
      table: { pair:"Correlation pair", n:"n =", rPrefix:"r = " },
      source: "n = number of animals per breed",
      tooltip: { breedLabel: "", pairLabel: "", rLabel: "r = " },
      groups: {
        bw: "Birth Weight",
        ww: "Weaning Weight (200-day)",
        yw: "Yearling Weight (365-day)",
        adg:"Average Daily Gain"
      },
      rows: {
        bw: [
          "Igenity EBV ↔ fvD NAV",
          "Igenity EBV ↔ Corrected BW",
          "fvD NAV ↔ Corrected BW"
        ],
        ww: [
          "Igenity EBV ↔ 200D NAV",
          "Igenity EBV ↔ Corrected WW",
          "200D NAV ↔ Corrected WW"
        ],
        yw: [
          "Igenity EBV ↔ 365vD NAV",
          "Igenity EBV ↔ Corrected YW",
          "365vD NAV ↔ Corrected YW"
        ],
        adg: [
          "Igenity EBV ↔ 365t NAV",
          "Igenity EBV ↔ Corrected ADG",
          "365t NAV ↔ Corrected ADG"
        ]
      }
    },
    sv: {
      title: "Korrelationer mellan ras × egenskap",
      subtitle: "Noggrannhet i genomisk prediktion mellan raser — hovra över celler för detaljer",
      tabs: { bw:"Födelsevikt", ww:"Avvänjningsvikt", yw:"Årsvikt", adg:"Daglig tillväxt (ADG)", all:"Alla egenskaper" },
      table: { pair:"Korrelationspar", n:"n =", rPrefix:"r = " },
      source: "n = antal djur per ras",
      tooltip: { breedLabel: "", pairLabel: "", rLabel: "r = " },
      groups: {
        bw: "Födelsevikt",
        ww: "Avvänjningsvikt (200 dagar)",
        yw: "Årsvikt (365 dagar)",
        adg:"Genomsnittlig daglig tillväxt"
      },
      rows: {
        bw: [
          "Igenity EBV ↔ fvD NAV",
          "Igenity EBV ↔ Korrigerad BW",
          "fvD NAV ↔ Korrigerad BW"
        ],
        ww: [
          "Igenity EBV ↔ 200D NAV",
          "Igenity EBV ↔ Korrigerad WW",
          "200D NAV ↔ Korrigerad WW"
        ],
        yw: [
          "Igenity EBV ↔ 365vD NAV",
          "Igenity EBV ↔ Korrigerad YW",
          "365vD NAV ↔ Korrigerad YW"
        ],
        adg: [
          "Igenity EBV ↔ 365t NAV",
          "Igenity EBV ↔ Korrigerad ADG",
          "365t NAV ↔ Korrigerad ADG"
        ]
      }
    }
  };

  // ===== Data (language-independent) =====
  const breeds = ['Angus','Blonde','Charolais','Hereford','Limousin','Simmental'];
  const nMain  = [14,9,77,32,14,37];
  const nSub   = [14,8,74,32,13,36];

  const groups = {
    bw: {
      dot: '#3a7ea8',
      n: nMain,
      rows: [
        { key:'bw', idx:0, vals:[0.07,0.52,0.06,0.58,0.31,0.34] },
        { key:'bw', idx:1, vals:[0.20,0.32,0.00,-0.02,0.18,0.28] },
        { key:'bw', idx:2, vals:[0.88,0.20,0.39,0.11,0.47,0.44] },
      ]
    },
    ww: {
      dot: '#3a8a65',
      n: nMain,
      rows: [
        { key:'ww', idx:0, vals:[-0.07,0.08,0.00,0.28,0.45,0.07] },
        { key:'ww', idx:1, vals:[0.42,-0.35,0.06,0.16,0.62,0.22] },
        { key:'ww', idx:2, vals:[0.45,0.71,0.62,0.16,0.18,0.55] },
      ]
    },
    yw: {
      dot: '#c2526e',
      n: nSub,
      rows: [
        { key:'yw', idx:0, vals:[-0.03,-0.19,0.00,0.53,0.23,0.02] },
        { key:'yw', idx:1, vals:[0.61,-0.58,0.23,0.42,0.52,0.14] },
        { key:'yw', idx:2, vals:[0.54,0.46,0.44,0.48,0.42,0.53] },
      ]
    },
    adg: {
      dot: '#7a3aaa',
      n: nSub,
      rows: [
        { key:'adg', idx:0, vals:[-0.04,-0.62,-0.02,0.39,-0.14,0.21] },
        { key:'adg', idx:1, vals:[0.20,0.53,0.18,0.35,-0.17,0.15] },
        { key:'adg', idx:2, vals:[0.43,-0.01,0.18,0.54,0.53,0.35] },
      ]
    }
  };

  // ===== Rendering + behavior =====
  let currentLang = 'en';

  function lerpColor(a, b, t) {
    const ah = parseInt(a.slice(1), 16), bh = parseInt(b.slice(1), 16);
    const ar = ah >> 16, ag = (ah >> 8) & 0xff, ab = ah & 0xff;
    const br = bh >> 16, bg = (bh >> 8) & 0xff, bb = bh & 0xff;
    return `rgb(${Math.round(ar + (br - ar) * t)},${Math.round(ag + (bg - ag) * t)},${Math.round(ab + (bb - ab) * t)})`;
  }

  function corrColor(v) {
    if (v === null || Number.isNaN(v)) return '#eee';
    const clamp = Math.max(-1, Math.min(1, v));
    const neutral = getComputedStyle(document.documentElement).getPropertyValue('--neutral').trim() || '#f0f1f3';
    if (clamp < 0) return lerpColor(neutral, '#c2526e', -clamp);
    return lerpColor(neutral, '#2d7a5c', clamp);
  }

  function textColor(v) {
    if (v === null || Number.isNaN(v)) return '#999';
    return Math.abs(v) > 0.45 ? 'white' : '#2a2d35';
  }

  function buildTable(key, data, container) {
    const T = i18n[currentLang];
    const groupLabel = T.groups[key];
    const rowsText = T.rows[key];

    const html = `
      <div class="group-title">
        <span class="dot" style="background:${data.dot}"></span>
        ${groupLabel}
      </div>
      <table>
        <thead>
          <tr>
            <th>${T.table.pair}</th>
            ${breeds.map(b => `<th>${b}</th>`).join('')}
          </tr>
        </thead>
        <tbody>
          <tr class="n-row">
            <td>${T.table.n}</td>
            ${data.n.map(n => `<td>${n}</td>`).join('')}
          </tr>
          ${data.rows.map((row) => `
            <tr>
              <td>${rowsText[row.idx]}</td>
              ${row.vals.map((v, i) => {
                const bg = corrColor(v);
                const tc = textColor(v);
                const sign = v > 0 ? '+' : '';
                const label = rowsText[row.idx];
                return `<td class="cell"
                  style="background:${bg}; color:${tc}"
                  data-breed="${breeds[i]}"
                  data-label="${label}"
                  data-val="${v}"
                >${sign}${Number(v).toFixed(2)}</td>`;
              }).join('')}
            </tr>
          `).join('')}
        </tbody>
      </table>
    `;
    container.innerHTML = html;
  }

  function buildAll(container) {
    container.innerHTML = '';
    Object.keys(groups).forEach(key => {
      const div = document.createElement('div');
      div.style.marginBottom = '2rem';
      buildTable(key, groups[key], div);
      container.appendChild(div);
    });
  }

  // Legend
  function buildLegend() {
    const bar = document.getElementById('legend-bar');
    bar.innerHTML = '';
    const steps = [-1,-0.75,-0.5,-0.25,0,0.25,0.5,0.75,1];
    steps.forEach(v => {
      const sw = document.createElement('div');
      sw.className = 'legend-swatch';
      sw.style.background = corrColor(v);
      sw.style.color = textColor(v);
      sw.textContent = v === 0 ? '0' : '';
      bar.appendChild(sw);
    });
  }

  // Tooltip (event delegation)
  const tip = document.getElementById('tooltip');

  function showTip(el, clientX, clientY) {
    const T = i18n[currentLang];
    tip.innerHTML = `<strong>${el.dataset.breed}</strong><br>${el.dataset.label}<br>${T.tooltip.rLabel}${el.dataset.val}`;
    tip.classList.add('show');
    tip.setAttribute('aria-hidden', 'false');
    moveTip(clientX, clientY);
  }

  function moveTip(clientX, clientY) {
    tip.style.left = (clientX + 14) + 'px';
    tip.style.top  = (clientY - 36) + 'px';
  }
  function hideTip() {
    tip.classList.remove('show');
    tip.setAttribute('aria-hidden', 'true');
  }

  document.addEventListener('mousemove', (e) => {
    if (tip.classList.contains('show')) moveTip(e.clientX, e.clientY);
  });

  document.addEventListener('mouseover', (e) => {
    const cell = e.target.closest('.cell');
    if (!cell) return;
    showTip(cell, e.clientX, e.clientY);
  });

  document.addEventListener('mouseout', (e) => {
    const fromCell = e.target.closest('.cell');
    const toCell = e.relatedTarget && e.relatedTarget.closest ? e.relatedTarget.closest('.cell') : null;
    if (fromCell && !toCell) hideTip();
  });

  // Tabs
  function showPanel(key) {
    document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.getElementById(`panel-${key}`).classList.add('active');
    document.querySelector(`.tab[data-key="${key}"]`).classList.add('active');
    hideTip();
  }

  document.querySelectorAll('.tab').forEach(btn => {
    btn.addEventListener('click', () => showPanel(btn.dataset.key));
  });

  // Language switching
  function setLang(lang) {
    currentLang = (lang === 'sv') ? 'sv' : 'en';

    // Toggle buttons
    document.getElementById('btn-en').classList.toggle('active', currentLang === 'en');
    document.getElementById('btn-sv').classList.toggle('active', currentLang === 'sv');

    // Update UI text
    const T = i18n[currentLang];
    document.getElementById('title').textContent = T.title;
    document.getElementById('subtitle').textContent = T.subtitle;
    document.getElementById('tab-bw').textContent = T.tabs.bw;
    document.getElementById('tab-ww').textContent = T.tabs.ww;
    document.getElementById('tab-yw').textContent = T.tabs.yw;
    document.getElementById('tab-adg').textContent = T.tabs.adg;
    document.getElementById('tab-all').textContent = T.tabs.all;
    document.getElementById('source').textContent = T.source;

    // Re-render tables so labels switch language
    Object.keys(groups).forEach(key => buildTable(key, groups[key], document.getElementById(`card-${key}`)));
    buildAll(document.getElementById('card-all'));
    buildLegend();
    hideTip();

    // Update <html lang="">
    document.documentElement.setAttribute('lang', currentLang);
  }

  document.getElementById('btn-en').addEventListener('click', () => setLang('en'));
  document.getElementById('btn-sv').addEventListener('click', () => setLang('sv'));

  // Initial render
  Object.keys(groups).forEach(key => buildTable(key, groups[key], document.getElementById(`card-${key}`)));
  buildAll(document.getElementById('card-all'));
  buildLegend();
  setLang('en');
</script>

</body>
</html>
